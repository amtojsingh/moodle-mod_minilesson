define ("mod_poodlltime/activitycontroller",["jquery","jqueryui","core/log","mod_poodlltime/definitions","mod_poodlltime/recorderhelper","mod_poodlltime/quizhelper"],function(a,b,c,d,e,f){"use strict";c.debug("Activity controller: initialising");return{cmid:null,activitydata:null,holderid:null,recorderid:null,playerid:null,sorryboxid:null,controls:null,ra_recorder:null,rec_time_start:0,passagefinished:d.passagefinished,clone:function clone(){return a.extend(!0,{},this)},init:function init(b){var d=this.clone(),e="#amdopts_"+b.widgetid,f=a(e).get(0);if(f){d.activitydata=JSON.parse(f.value);a(e).remove()}else{c.debug("Poodll Time Test Controller: No config found on page. Giving up.");return}d.cmid=b.cmid;d.holderid=b.widgetid+"_holder";d.recorderid=b.widgetid+"_recorder";d.playerid=b.widgetid+"_player";d.sorryboxid=b.widgetid+"_sorrybox";if(!d.is_browser_ok()){a("#"+d.sorryboxid).show();return}d.process_html();d.register_events();d.doquizlayout()},process_html:function process_html(){var b=this.activitydata,c={hider:a("."+b.hider),introbox:a(".mod_intro_box"),quizcontainer:a("."+b.quizcontainer),progresscontainer:a("."+b.progresscontainer),feedbackcontainer:a("."+b.feedbackcontainer),errorcontainer:a("."+b.errorcontainer),passagecontainer:a("."+b.passagecontainer),recordingcontainer:a("."+b.recordingcontainer),dummyrecorder:a("."+b.dummyrecorder),recordercontainer:a("."+b.recordercontainer),instructionscontainer:a("."+b.instructionscontainer),recinstructionscontainerright:a("."+b.recinstructionscontainerright),recinstructionscontainerleft:a("."+b.recinstructionscontainerleft),allowearlyexit:a("."+b.allowearlyexit),wheretonextcontainer:a("."+b.wheretonextcontainer)};this.controls=c},beginall:function beginall(){var a=this;a.passagerecorded=!0},is_browser_ok:function is_browser_ok(){return navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia},setup_recorder:function setup_recorder(){var a=this;e.init(a.activitydata,function on_recording_start(){a.rec_time_start=new Date().getTime();a.dopassagelayout();a.controls.passagecontainer.show(1e3,a.beginall)},function on_recording_end(){var b=new Date().getTime();if(3e3>b-a.rec_time_start){return}a.douploadlayout()},function on_audio_processing(b){var c=new Date().getTime(),d=c-a.rec_time_start;if(0<d){d=Math.ceil(d/1e3)}a.send_submission(b.mediaurl,d)})},register_events:function register_events(){this},send_submission:function send_submission(a,b){var d=new XMLHttpRequest,e=this;d.onreadystatechange=function(){if(4===this.readyState){if(200==d.status){c.debug("ok we got an attempt submission response");var a=d.responseText,b=JSON.parse(a);if(b){switch(b.success){case!1:c.debug("attempted item evaluation failure");if(b.message){c.debug("message: "+b.message)}case!0:default:c.debug("attempted submission accepted");e.attemptid=b.data;e.doquizlayout();break;}}}else{c.debug("Not 200 response:"+d.status)}}};var f="cmid="+e.cmid+"&filename="+a+"&rectime="+b;d.open("POST",M.cfg.wwwroot+"/mod/poodlltime/ajaxhelper.php",!0);d.setRequestHeader("Content-Type","application/x-www-form-urlencoded");d.setRequestHeader("Cache-Control","no-cache");d.send(f)},dopassagelayout:function dopassagelayout(){var a=this;a.controls.introbox.hide();a.controls.quizcontainer.hide();if(a.controls.allowearlyexit){}},douploadlayout:function douploadlayout(){var a=this;a.controls.passagecontainer.addClass(a.passagefinished);a.controls.hider.fadeIn("fast");a.controls.progresscontainer.fadeIn("fast")},doquizlayout:function doquizlayout(){var a=this;a.controls.hider.fadeOut("fast");a.controls.progresscontainer.fadeOut("fast");a.controls.instructionscontainer.hide();a.controls.passagecontainer.hide();a.controls.recordingcontainer.hide();f.onSubmit=function(b){a.dofinishedreadinglayout(b)};f.init(a.controls.quizcontainer,this.activitydata.quizdata,this.cmid,this.attemptid,this.activitydata.passagepictureurl);a.controls.quizcontainer.show()},dofinishedreadinglayout:function dofinishedreadinglayout(a){var b=this;b.controls.quizcontainer.hide();b.controls.feedbackcontainer.show();if(a&&a.success&&a.data){var c=a.data;b.controls.feedbackcontainer.append("<img src=\""+c.picurl+"\"></img>")}b.controls.wheretonextcontainer.show()},doerrorlayout:function doerrorlayout(){var a=this;a.controls.hider.fadeOut("fast");a.controls.progresscontainer.fadeOut("fast");a.controls.passagecontainer.hide();a.controls.recordingcontainer.hide();a.controls.errorcontainer.show();a.controls.wheretonextcontainer.show()}}});
//# sourceMappingURL=activitycontroller.min.js.map
