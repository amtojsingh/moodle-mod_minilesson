{"version":3,"sources":["../src/rsquestionmanager.js"],"names":["define","$","jqui","log","templates","def","mfh","mdh","mih","datatables","debug","cmid","controls","rowIds","init","props","dd","contextid","tableid","register_events","process_html","collate_rowids","hide_useless_arrows","questionstable","getDataTable","questionscontainer","mod_poodlltime_items_cont","noquestionscontainer","mod_poodlltime_noitems_cont","movearrows","movearrow","itemrow","each","item","rowindex","row","index","itemorder","cell","column","data","attr","rowcount","length","bottomrowindex","bottomtr","node","find","toprowindex","toptr","renumber_rows","fromorder","thetable","move_row","itemid","direction","therow","currentrow","currentindex","currentorder","parseInt","targetorder","targetindex","from","to","draw","qtypes","qtype_dictation","qtype_dictationchat","qtype_page","qtype_speechcards","qtype_listenrepeat","qtype_multichoice","component","after_questionadd","id","typelabel","type","up","down","render","then","html","add","hide","show","after_questionedit","name","after_questiondelete","remove","itemcount","rows","count","after_questionmove"],"mappings":"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","sourcesContent":["/* jshint ignore:start */\ndefine(['jquery','jqueryui', 'core/log','core/templates','mod_poodlltime/definitions','mod_poodlltime/modalformhelper',\n        'mod_poodlltime/modaldeletehelper','mod_poodlltime/moveitemhelper','mod_poodlltime/datatables'],\n    function($, jqui, log, templates, def, mfh, mdh, mih, datatables) {\n\n    \"use strict\"; // jshint ;_;\n\n    log.debug('RSQuestion manager: initialising');\n\n    return {\n\n        cmid: null,\n        controls: null,\n        rowIds: [],\n\n\n        //pass in config\n        init: function(props){\n            var dd = this;\n            dd.contextid=props.contextid;\n            dd.tableid = props.tableid;\n\n            dd.register_events();\n            dd.process_html();\n            dd.collate_rowids();\n            dd.hide_useless_arrows();\n        },\n\n        process_html: function(){\n            this.controls = [];\n            this.controls.questionstable = datatables.getDataTable(this.tableid);\n            this.controls.questionscontainer = $('#' + def.mod_poodlltime_items_cont);\n            this.controls.noquestionscontainer = $('#' + def.mod_poodlltime_noitems_cont);\n            this.controls.movearrows=$('#' + def.movearrow);\n        },\n\n        //we maintain an array of datatable rowids, indexed by itemorder\n        //we need this because moving, adding, deleting requires access to datatable rowid\n        collate_rowids: function(){\n            var dd = this;\n            dd.rowIds=[];\n            $(\".\" + def.itemrow).each(function(item){\n                var rowindex = dd.controls.questionstable.row(item).index();\n                var itemorder = dd.controls.questionstable.cell({row:rowindex, column:0}).data();\n                dd.rowIds[itemorder]=rowindex;\n            });\n\n        },\n\n        //we wont to show move arrows, but hide arrows the final down and first up\n        hide_useless_arrows: function(){\n          //first lets show all the arrows\n          $('.mod_poodlltime_item_move').attr('style','');\n\n          //if no rows just get out of here.\n          var rowcount=this.controls.questionstable.data().length;\n          if(!rowcount || rowcount<1){return;}\n\n          //hide bottom down arrow\n          var bottomrowindex=this.rowIds[rowcount];\n          var bottomtr = this.controls.questionstable.row(bottomrowindex).node();\n          $(bottomtr).find('.mod_poodlltime_item_move[data-direction=\"down\"]').attr('style','visibility: hidden;');\n\n          //hide top up arrow\n          var toprowindex=this.rowIds[0];\n          var toprowindex=this.rowIds[1];\n          var toptr = this.controls.questionstable.row(toprowindex).node();\n          $(toptr).find('.mod_poodlltime_item_move[data-direction=\"up\"]').attr('style','visibility: hidden;');\n        },\n\n        // we need to renumber rows when we remove one, so we start from there and renumber the next ones\n        renumber_rows:function(fromorder) {\n\n            var thetable= this.controls.questionstable;\n            var rowcount = thetable.data().length;\n            for(var itemorder =fromorder; itemorder<rowcount;itemorder++){\n                var rowindex = this.rowIds[itemorder+1];\n                thetable.cell({row:rowindex, column:0}).data(itemorder);\n            }\n        },\n\n        move_row:function(itemid, direction) {\n            var thetable= this.controls.questionstable;\n            var therow = '#' + def.itemrow + '_' + itemid;\n            var currentrow = thetable.row(therow);\n            var currentindex = currentrow.index();\n            var currentorder = parseInt(thetable.cell({row:currentindex, column:0}).data());\n\n\n            var targetorder;\n            if(direction==\"up\"){\n                targetorder=currentorder-1;\n            } else if(direction==\"down\"){\n                targetorder=currentorder+1;\n            }\n\n            //should never arrive here pitching for out of range. But just in case\n            if(targetorder<1){return;}\n            var rowcount = thetable.data().length;\n            if(targetorder>rowcount){return;}\n\n            var targetindex = this.rowIds[targetorder];\n            var from = thetable.cell({row:currentindex, column:0}).data();\n            var to = thetable.cell({row:targetindex, column:0}).data();\n            thetable.cell({row:currentindex, column:0}).data(to);\n            thetable.cell({row:targetindex, column:0}).data(from);\n            thetable.draw();\n            this.collate_rowids();\n            \n        },\n        register_events: function() {\n          \n            var dd = this;\n          \n            var qtypes =[def.qtype_dictation,def.qtype_dictationchat,def.qtype_page,\n                def.qtype_speechcards,def.qtype_listenrepeat, def.qtype_multichoice];\n\n            var after_questionmove= function(itemid, direction) {\n                dd.move_row(itemid,direction);\n                dd.hide_useless_arrows();\n            };\n\n            var after_questionedit= function(item, itemid) {\n                var therow = '#' + def.itemrow + '_' + itemid;\n                dd.controls.questionstable.cell($(therow + ' .c1')).data(item.name);\n            };\n            var after_questionadd= function(item, itemid) {\n                item.id = itemid;\n                item.typelabel = item.type;\n                item.index = dd.controls.questionstable.data().length+1;\n                item.up = {'key': 't/up','component': 'moodle','title': 'up'};\n                item.down = {'key': 't/down','component': 'moodle','title': 'down'};\n                templates.render('mod_poodlltime/itemlistitem',item).then(\n                    function(html,js){\n                        dd.controls.questionstable.row.add($(html)[0]).draw();\n                        dd.collate_rowids();\n                        dd.hide_useless_arrows();\n                    }\n                );\n                dd.controls.noquestionscontainer.hide();\n                dd.controls.questionscontainer.show();\n            };\n            var after_questiondelete= function(itemid) {\n                log.debug('after question delete');\n                var therow=dd.controls.questionstable.row('#' + def.itemrow + '_' + itemid);\n                var itemorder=parseInt(therow.data()[0]);\n                dd.renumber_rows(itemorder);\n                therow.remove().draw();\n                dd.collate_rowids();\n                dd.hide_useless_arrows();\n                var itemcount = dd.controls.questionstable.rows().count();\n                if(!itemcount){\n                    dd.controls.noquestionscontainer.show();\n                    dd.controls.questionscontainer.hide();\n                }\n            };\n\n            //register ajax modal handler\n            var editcallback=function(item, itemid){console.log(item);};\n            var deletecallback=function(itemid){console.log(itemid);};\n            var addcallback=function(itemid){console.log(itemid);};\n            mfh.init('.' + def.component + '_addlink', dd.contextid,after_questionadd);\n            //edit form helper\n            mfh.init('.' + def.itemrow + '_editlink', dd.contextid,after_questionedit);\n            //delete helpser\n            mdh.init('.' + def.itemrow + '_deletelink', dd.contextid, 'deleteitem',after_questiondelete);\n            //move helper\n            mih.init('.' + def.movearrow , dd.contextid, after_questionmove);\n        }\n\n    };//end of returned object\n});//total end\n"],"file":"rsquestionmanager.min.js"}