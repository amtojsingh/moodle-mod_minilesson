define ("mod_poodlltime/ttrecorder",["jquery","core/log","mod_poodlltime/ttaudiohelper","core/notification"],function(a,b,c,d){"use strict";b.debug("TT Recorder: initialising");var e={waveHeight:75,audio:{stream:null,blob:null,dataURI:null,start:null,end:null,isRecording:!1,isRecognizing:!1,transcript:null},submitting:!1,owner:"",controls:{},uniqueid:null,audio_updated:null,maxTime:15e3,passagehash:null,region:null,asrurl:null,init:function init(a){this.uniqueid=a.uniqueid;this.callback=a.callback;this.prepare_html();this.register_events();c.init(this.waveHeight,this.uniqueid,this);c.onError=this.error;c.onStop=this.stopped;c.onStream=this.got_stream},prepare_html:function prepare_html(){this.controls.recordercontainer=a("#ttrec_container_"+this.uniqueid);this.controls.recorderbutton=a("#"+this.uniqueid+"_recorderdiv");this.passagehash=this.controls.recorderbutton.data("passagehash");this.region=this.controls.recorderbutton.data("region");this.asrurl=this.controls.recorderbutton.data("asrurl");this.maxTime=this.controls.recorderbutton.data("maxtime");this.waveHeight=this.controls.recorderbutton.data("waveheight")},update_audio:function update_audio(a,c){if("string"==typeof a){b.debug("update_audio:"+a+":"+c);if(this.audio[a]!=c){this.audio[a]=c;this.audio_updated()}}else{for(var d in a){this.audio[d]=a[d];b.debug("update_audio:"+d+":"+a[d])}this.audio_updated()}},register_events:function register_events(){var a=this;this.controls.recordercontainer.click(function(){a.toggleRecording()});this.audio_updated=function(){if(a.audio.isRecognizing||a.isComplete()){a.show_recorder_pointer("none")}else{a.show_recorder_pointer("auto")}if(a.isComplete()){a.show_recorder_complete(!0)}else{a.show_recorder_complete(!1)}a.controls.recorderbutton.html(a.recordBtnContent())}},show_recorder_pointer:function show_recorder_pointer(a){if(a){this.controls.recorderbutton.css("pointer-events","none")}else{this.controls.recorderbutton.css("pointer-events","auto")}},show_recorder_complete:function show_recorder_complete(a){if(a){this.controls.recorderbutton.css("background","green")}else{this.controls.recorderbutton.css("background","#e52")}},gotRecognition:function gotRecognition(a){b.debug("transcript");e.callback({type:"speech",capturedspeech:a})},cleanWord:function cleanWord(a){return a.replace(/[^a-zA-Z0-9]/g,"").toLowerCase()},recordBtnContent:function recordBtnContent(){if(!e.audio.isRecognizing){if(!e.isComplete()){if(e.audio.isRecording){return"<i class=\"fa fa-stop\">"}else{return"<i class=\"fa fa-microphone\">"}}else{return"<i class=\"fa fa-check\">"}}else{return"<i class=\"fa fa-spinner fa-spin\">"}},toggleRecording:function toggleRecording(){if(e.audio.isRecording){e.update_audio("isRecognizing",!0);c.stop()}else{e.start()}},got_stream:function got_stream(a){e.update_audio({stream:a,isRecording:!0});e.currentTime=0;e.interval=setInterval(function(){if(e.currentTime<e.maxTime){e.currentTime+=10}else{e.update_audio("isRecognizing",!0);c.stop()}},10)},start:function start(){var a={stream:null,blob:null,dataURI:null,start:new Date,end:null,isRecording:!1,isRecognizing:!1,transcript:null};e.update_audio(a);c.start()},stopped:function stopped(a){clearInterval(e.interval);var c={blob:a,dataURI:URL.createObjectURL(a),end:new Date,isRecording:!1,length:Math.round((e.audio.end-e.audio.start)/1e3)};e.update_audio(c);e.deepSpeech2(e.audio.blob,function(a){b.debug(a);e.update_audio("isRecognizing",!1);if("success"==a.data.result&&a.data.transcript){e.gotRecognition(a.data.transcript.trim())}else{d.alert("Information","We could not recognize your speech.","OK")}})},error:function error(a){switch(a.name){case"PermissionDeniedError":case"NotAllowedError":d.alert("Error","Please allow access to your microphone!","OK");break;case"DevicesNotFoundError":case"NotFoundError":d.alert("Error","No microphone detected!","OK");break;}},deepSpeech2:function deepSpeech2(a,b){var c=new FormData,d=e.uniqueid+Math.floor(100*Math.random())+".wav";c.append("audioFile",a,d);c.append("scorer",e.passagehash);var f=new XMLHttpRequest;f.open("POST",e.asrurl,!0);f.onUploadProgress=function(){};f.onload=function(){if(200===f.status){b(JSON.parse(f.response))}else{console.error(f.error)}};f.send(c)},isComplete:function isComplete(){return!1}};return e});
//# sourceMappingURL=ttrecorder.min.js.map
