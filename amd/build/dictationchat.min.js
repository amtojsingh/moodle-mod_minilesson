define(["jquery","core/log","core/ajax","mod_poodlltime/definitions","mod_poodlltime/pollyhelper"],function(a,b,c,d,e){"use strict";return b.debug("Poodll Time dictation chat: initialising"),{init:function(a,b,c){var d=this;d.itemdata=b,d.quizhelper=c,d.index=a,d.register_events(),d.setvoice(),d.getItems()},next_question:function(){var a=this,b={};b.index=a.index,b.hasgrade=!0,b.totalitems=a.items.length,b.correctitems=a.items.filter(function(a){return a.correct}).length,b.grade=Math.round(b.totalitems/b.correctitems*100),a.quizhelper.do_next(b)},register_events:function(){var b=this;a("#"+b.itemdata.uniqueid+"_container .poodlltime_nextbutton").on("click",function(a){b.next_question()}),a("#"+b.itemdata.uniqueid+"_container .dictate_start_btn").on("click",function(){b.start()}),a("#"+b.itemdata.uniqueid+"_container .dictate_listen_btn").on("click",function(){b.items[b.game.pointer].audio.load(),b.items[b.game.pointer].audio.play()}),a("#"+b.itemdata.uniqueid+"_container .dictate_skip_btn").on("click",function(){a("#"+b.itemdata.uniqueid+"_container .dictate_ctrl-btn").prop("disabled",!0),a("#"+b.itemdata.uniqueid+"_container .dictate_speech.dictate_teacher_left").text(b.items[b.game.pointer].target+""),setTimeout(function(){b.game.pointer<b.items.length-1?(b.items[b.game.pointer].answered=!0,b.items[b.game.pointer].correct=!1,b.game.pointer++,b.nextPrompt()):b.end()},3e3)}),a("#"+b.itemdata.uniqueid+"_container .dictate_check_btn").on("click",function(){b.check_answer()}),a("body").on("keydown",".dictate_targetWord",function(a){13==a.which&&b.check_answer()})},spliton:new RegExp('([,.!?:;" ])',"g"),game:{pointer:0},usevoice:"Amy",check_answer:function(){var b=this,c=b.items[b.game.pointer].target,d=[];a("#"+b.itemdata.uniqueid+"_container .dictate_targetWord").each(function(){d.push(""==a(this).val().trim()?"|":a(this).val().trim())});var e=d.join(" ");b.getComparison(c,e,function(a){b.gotComparison(a,e)})},setvoice:function(){var a=this,b="English(US)",c="Female",d="Amy";switch(b){case"English(US)":d="Male"===c?"Joey":"Kendra";break;case"English(GB)":d="Male"===c?"Brian":"Amy";break;case"English(AU)":d="Male"===c?"Russell":"Nicole";break;case"English(IN)":d="Male"===c?"Aditi":"Raveena";break;case"English(Welsh)":d="Geraint";break;case"Danish":d="Male"===c?"Mads":"Naja";break;case"Dutch":d="Male"===c?"Ruben":"Lotte";break;case"French(FR)":d="Male"===c?"Mathieu":"Celine";break;case"French(CA)":d="Chantal";break;case"German":d="Male"===c?"Hans":"Marlene";break;case"Icelandic":d="Male"===c?"Karl":"Dora";break;case"Italian":d="Male"===c?"Carla":"Giorgio";break;case"Japanese":d="Male"===c?"Takumi":"Mizuki";break;case"Korean":d="Seoyan";break;case"Norwegian":d="Liv";break;case"Polish":d="Male"===c?"Jacek":"Ewa";break;case"Portugese(BR)":d="Male"===c?"Ricardo":"Vitoria";break;case"Portugese(PT)":d="Male"===c?"Cristiano":"Ines";break;case"Romanian":d="Carmen";break;case"Russian":d="Male"===c?"Maxim":"Tatyana";break;case"Spanish(ES)":d="Male"===c?"Enrique":"Conchita";break;case"Spanish(US)":d="Male"===c?"Miguel":"Penelope";break;case"Swedish":d="Astrid";break;case"Turkish":d="Filiz";break;case"Welsh":d="Gwyneth";break;default:d="Male"===c?"Brian":"Amy"}a.usevoice=d},getItems:function(){var b=this,c=b.itemdata.customtext1.split("\n");b.items=c.map(function(a){return{dictate_targetWords:a.trim().split(b.spliton).filter(function(a){return""!==a}),target:a,typed:"",answered:!1,correct:!1,audio:null}}).filter(function(a){return""!==a.target}),a.each(b.items,function(a,c){e.fetch_polly_url(c.target,"text","Amy").then(function(a){c.audio=new Audio,c.audio.src=a,0==b.items.filter(function(a){return null==a.audio}).length?b.appReady():console.log(b.items)})})},appReady:function(){var b=this;a("#"+b.itemdata.uniqueid+"_container .dictate_not_loaded").hide(),a("#"+b.itemdata.uniqueid+"_container .dictate_loaded").show(),a("#"+b.itemdata.uniqueid+"_container .dictate_start_btn").prop("disabled",!1)},gotComparison:function(b,c){var d=this;a("#"+d.itemdata.uniqueid+"_container .dictate_targetWord").removeClass("dictate_correct dictate_incorrect"),a("#"+d.itemdata.uniqueid+"_container .dictate_feedback").removeClass("fa fa-check fa-times");var e=0==b.filter(function(a){return!a.matched}).length;e?(a("#"+d.itemdata.uniqueid+"_container .dictate_targetWord").addClass("dictate_correct").prop("disabled",!0),a("#"+d.itemdata.uniqueid+"_container .dictate_feedback").addClass("fa fa-check"),a("#"+d.itemdata.uniqueid+"_container .dictate_speech.dictate_teacher_left").text(d.items[d.game.pointer].target+""),d.items[d.game.pointer].answered=!0,d.items[d.game.pointer].correct=!0,d.items[d.game.pointer].typed=c,a("#"+d.itemdata.uniqueid+"_container .dictate_ctrl-btn").prop("disabled",!0),d.game.pointer<d.items.length-1?setTimeout(function(){d.game.pointer++,d.nextPrompt()},3e3):setTimeout(function(){d.end()},3e3)):(b.forEach(function(b){b.matched?(a("#"+d.itemdata.uniqueid+"_container .dictate_targetWord[data-idx='"+b.wordnumber+"']").addClass("dictate_correct").prop("disabled",!0),a("#"+d.itemdata.uniqueid+"_container .dictate_feedback[data-idx='"+b.wordnumber+"']").addClass("fa fa-check")):(a("#"+d.itemdata.uniqueid+"_container .dictate_targetWord[data-idx='"+b.wordnumber+"']").addClass("dictate_incorrect"),a("#"+d.itemdata.uniqueid+"_container .dictate_feedback[data-idx='"+b.wordnumber+"']").addClass("fa fa-times"))}),a("#"+d.itemdata.uniqueid+"_container .dictate_reply_"+d.game.pointer).effect("shake",function(){a("#"+d.itemdata.uniqueid+"_container .dictate_ctrl-btn").prop("disabled",!1)})),a("#"+d.itemdata.uniqueid+"_container .dictate_targetWord.dictate_correct").each(function(){var b=a(this).data("realidx"),c=d.items[d.game.pointer].dictate_targetWords[b];a(this).val(c)})},getWords:function(a){var b=this,c=!1;"false"==c&&(a=a.toLowerCase());for(var d=a.split(b.spliton).filter(function(a){return""!==a}),e=[],f=0;f<d.length;f++)d[f].match(b.spliton)||e.push(d[f]);return e},getComparison:function(b,c,d){a(".dictate_ctrl-btn").prop("disabled",!0);var e,f=[],g=c.split(/ /),h=b.split(/ /);g.forEach(function(a,b){e=h[b].toLowerCase()==a.toLowerCase(),f.push({word:a,matched:e,wordnumber:b+1})}),d(f)},end:function(){var b=this,c=b.items.filter(function(a){return a.correct}).length,d=b.items.length;a("#"+b.itemdata.uniqueid+"_container .dictate_results").html("TOTAL<br/>"+c+"/"+d).show(),a(".poodlltime_nextbutton").prop("disabled",!0),setTimeout(function(){a(".poodlltime_nextbutton").prop("disabled",!1),b.next_question()},2e3)},start:function(){var b=this;a("#"+b.itemdata.uniqueid+"_container .dictate_ctrl-btn").prop("disabled",!0),b.items.forEach(function(a){a.spoken="",a.answered=!1,a.correct=!1}),b.game.pointer=0,a("#"+b.itemdata.uniqueid+"_container .dictate_game").show(),a("#"+b.itemdata.uniqueid+"_container .dictate_start_btn").hide(),a("#"+b.itemdata.uniqueid+"_container .dictate_mainmenu").hide(),a("#"+b.itemdata.uniqueid+"_container .dictate_controls").show(),b.nextPrompt()},nextPrompt:function(){var b=this,c=b.items[b.game.pointer].target,d="<div class='dictate_prompt dictate_prompt_"+b.game.pointer+"' style='display:none;'>";d+="<i class='fa fa-graduation-cap dictate_speech-icon-left'></i>",d+="<div style='margin-left:90px;' class='dictate_speech dictate_teacher_left'>",d+=c.replace(/[^a-zA-Z0-9 ]/g,"").replace(/[a-zA-Z0-9]/g,"â€¢"),d+="</div>",d+="</div>",a("#"+b.itemdata.uniqueid+"_container .dictate_game").html(d),a(".dictate_ctrl-btn").prop("disabled",!1);var e,f=b.items.map(function(a,c){return e="gray",b.items[c].answered&&b.items[c].correct?e="green":b.items[c].answered&&!b.items[c].correct&&(e="red"),"<i style='color:"+e+"' class='fa fa-circle'></i>"}).join(" ");a("#"+b.itemdata.uniqueid+"_container .dictate_title").html(f),a(".dictate_prompt_"+b.game.pointer).toggle("slide",{direction:"left"}),b.nextReply()},nextReply:function(){var b=this,c=(b.items[b.game.pointer].target,"<div class='dictate_reply dictate_reply_"+b.game.pointer+"' style='display:none;'>");c+="<i class='fa fa-user dictate_speech-icon-right'></i>";var d="",e=1;b.items[b.game.pointer].dictate_targetWords.forEach(function(a,c){a.match(b.spliton)?d+=a:(d+="<ruby><input type='text' maxlength='"+a.length+"' size='"+(a.length+1)+"' class='dictate_targetWord' data-realidx='"+c+"' data-idx='"+e+"'><rt><i data-idx='"+e+"' class='dictate_feedback'></i></rt></ruby>",e++)}),c+="<div style='margin-right:90px;' class='dictate_speech dictate_right'>"+d+"</div>",c+="</div>",a("#"+b.itemdata.uniqueid+"_container .dictate_game").append(c),a(".dictate_reply_"+b.game.pointer).toggle("slide",{direction:"right"}),a("#"+b.itemdata.uniqueid+"_container .dictate_ctrl-btn").prop("disabled",!1),setTimeout(function(){a(".dictate_targetWord").first().focus(),a("#"+b.itemdata.uniqueid+"_container .dictate_listen_btn").trigger("click")},500)}}});