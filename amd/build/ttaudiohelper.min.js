define ("mod_poodlltime/ttaudiohelper",["jquery","core/log","mod_poodlltime/ttwavencoder"],function(a,b,c){"use strict";b.debug("TT Audio Helper initialising");var d={encoder:null,microphone:null,isRecording:!1,audioContext:null,processor:null,uniqueid:null,config:{bufferLen:4096,numChannels:2,mimeType:"audio/wav"},init:function init(a,b,c){d.waveHeight=a;d.uniqueid=b;d.therecorder=c;this.prepare_html();window.AudioContext=window.AudioContext||window.webkitAudioContext},onStop:function onStop(){},onStream:function onStream(){},onError:function onError(){},prepare_html:function prepare_html(){d.canvas=a("#"+d.uniqueid+"_waveform");d.canvasCtx=d.canvas[0].getContext("2d")},start:function start(){d.audioContext=new AudioContext;if(d.audioContext.createJavaScriptNode){d.processor=d.audioContext.createJavaScriptNode(d.config.bufferLen,d.config.numChannels,d.config.numChannels)}else if(d.audioContext.createScriptProcessor){d.processor=d.audioContext.createScriptProcessor(d.config.bufferLen,d.config.numChannels,d.config.numChannels)}else{b.debug("WebAudio API has no support on this browser.")}d.processor.connect(d.audioContext.destination);navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(d.gotStreamMethod).catch(d.onError)},stop:function stop(){clearInterval(d.interval);d.canvasCtx.clearRect(0,0,2*d.canvas.width(),2*this.waveHeight);d.isRecording=!1;d.therecorder.update_audio("isRecording",!1);d.audioContext.close();d.processor.disconnect();d.tracks.forEach(function(a){return a.stop()});d.onStop(d.encoder.finish())},getBuffers:function getBuffers(a){for(var b=[],c=0;2>c;++c){b[c]=a.inputBuffer.getChannelData(c)}return b},gotStreamMethod:function gotStreamMethod(a){d.onStream(a);d.isRecording=!0;d.therecorder.update_audio("isRecording",!0);d.tracks=a.getTracks();d.microphone=d.audioContext.createMediaStreamSource(a);d.microphone.connect(d.processor);d.encoder=c;d.encoder.init(d.audioContext.sampleRate,2);d.processor.onaudioprocess=function(a){d.encoder.encode(d.getBuffers(a))};d.listener=d.audioContext.createAnalyser();d.microphone.connect(d.listener);d.listener.fftSize=2048;d.bufferLength=d.listener.frequencyBinCount;d.analyserData=new Uint8Array(d.bufferLength);d.canvasCtx.clearRect(0,0,2*d.canvas.width(),2*d.waveHeight);d.interval=setInterval(function(){d.drawWave()},100)},drawWave:function drawWave(){var a=2*d.canvas.width();d.listener.getByteTimeDomainData(d.analyserData);d.canvasCtx.fillStyle="white";d.canvasCtx.fillRect(0,0,a,2*d.waveHeight);d.canvasCtx.lineWidth=5;d.canvasCtx.strokeStyle="gray";d.canvasCtx.beginPath();for(var b=a/d.bufferLength,c=0,e=0;e<d.bufferLength;e++){var f=d.analyserData[e]/128,g=f*d.waveHeight;if(!(0==e)){d.canvasCtx.lineTo(c,g)}c+=b}d.canvasCtx.lineTo(a,d.waveHeight);d.canvasCtx.stroke()}};return d});
//# sourceMappingURL=ttaudiohelper.min.js.map
