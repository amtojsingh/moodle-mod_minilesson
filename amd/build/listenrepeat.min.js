define(["jquery","core/log","core/ajax","mod_poodlltime/definitions","mod_poodlltime/pollyhelper","mod_poodlltime/cloudpoodllloader"],function(a,b,c,d,e,f){"use strict";return b.debug("Poodll Time listen and repeat: initialising"),{init:function(a,c,d){var e=this;f.init("poodlltime-recorder-listenrepeat-"+c.id,function(a){switch(a.type){case"recording":break;case"speech":b.debug("speech at listen_repeat"),e.getComparison(e.items[e.game.pointer].target,a.capturedspeech,function(b){e.gotComparison(b,a)})}}),e.itemdata=c,e.quizhelper=d,e.index=a,e.register_events(),e.setvoice(),e.getItems()},next_question:function(a){var b=this,c={};c.index=b.index,c.hasgrade=!0,c.totalitems=b.items.length,c.correctitems=b.items.filter(function(a){return a.correct}).length,c.grade=Math.round(c.totalitems/c.correctitems*100),b.quizhelper.do_next(c)},register_events:function(){var b=this;a("#"+b.itemdata.uniqueid+"_container .poodlltime_nextbutton").on("click",function(a){b.next_question()}),a("#"+b.itemdata.uniqueid+"_container .landr_start_btn").on("click",function(){b.start()}),a("#"+b.itemdata.uniqueid+"_container .landr_listen_btn").on("click",function(){b.items[b.game.pointer].audio.load(),b.items[b.game.pointer].audio.play()}),a("#"+b.itemdata.uniqueid+"_container .landr_skip_btn").on("click",function(){a("#"+b.itemdata.uniqueid+"_container .landr_ctrl-btn").prop("disabled",!0),a("#"+b.itemdata.uniqueid+"_container .landr_speech.landr_teacher_left").text(b.items[b.game.pointer].target+""),setTimeout(function(){b.game.pointer<b.items.length-1?(b.items[b.game.pointer].answered=!0,b.items[b.game.pointer].correct=!1,b.game.pointer++,b.nextPrompt()):b.end()},3e3)})},spliton:new RegExp('([,.!?:;" ])',"g"),game:{pointer:0},usevoice:"",setvoice:function(){var a,b=this,c="English(US)",d="Female";switch(c){case"English(US)":a="Male"===d?"Joey":"Kendra";break;case"English(GB)":a="Male"===d?"Brian":"Amy";break;case"English(AU)":a="Male"===d?"Russell":"Nicole";break;case"English(IN)":a="Male"===d?"Aditi":"Raveena";break;case"English(Welsh)":a="Geraint";break;case"Danish":a="Male"===d?"Mads":"Naja";break;case"Dutch":a="Male"===d?"Ruben":"Lotte";break;case"French(FR)":a="Male"===d?"Mathieu":"Celine";break;case"French(CA)":a="Chantal";break;case"German":a="Male"===d?"Hans":"Marlene";break;case"Icelandic":a="Male"===d?"Karl":"Dora";break;case"Italian":a="Male"===d?"Carla":"Giorgio";break;case"Japanese":a="Male"===d?"Takumi":"Mizuki";break;case"Korean":a="Seoyan";break;case"Norwegian":a="Liv";break;case"Polish":a="Male"===d?"Jacek":"Ewa";break;case"Portugese(BR)":a="Male"===d?"Ricardo":"Vitoria";break;case"Portugese(PT)":a="Male"===d?"Cristiano":"Ines";break;case"Romanian":a="Carmen";break;case"Russian":a="Male"===d?"Maxim":"Tatyana";break;case"Spanish(ES)":a="Male"===d?"Enrique":"Conchita";break;case"Spanish(US)":a="Male"===d?"Miguel":"Penelope";break;case"Swedish":a="Astrid";break;case"Turkish":a="Filiz";break;case"Welsh":a="Gwyneth";break;default:a="Male"===d?"Brian":"Amy"}b.usevoice=a},getItems:function(){var b=this,c=b.itemdata.customtext1.split("\n");b.items=c.map(function(a){return{landr_targetWords:a.trim().split(b.spliton).filter(function(a){return""!==a}),target:a,typed:"",answered:!1,correct:!1,audio:null}}).filter(function(a){return""!==a.target}),a.each(b.items,function(a,c){e.fetch_polly_url(c.target,"text",b.usevoice).then(function(a){c.audio=new Audio,c.audio.src=a,0==b.items.filter(function(a){return null==a.audio}).length&&b.appReady()})})},appReady:function(){var b=this;a("#"+b.itemdata.uniqueid+"_container .landr_not_loaded").hide(),a("#"+b.itemdata.uniqueid+"_container .landr_loaded").show(),a("#"+b.itemdata.uniqueid+"_container .landr_start_btn").prop("disabled",!1)},gotComparison:function(b,c){var d=this;a("#"+d.itemdata.uniqueid+"_container .landr_targetWord").removeClass("landr_correct landr_incorrect"),a("#"+d.itemdata.uniqueid+"_container .landr_feedback").removeClass("fa fa-check fa-times");var e=0==b.filter(function(a){return!a.matched}).length;e?(a("#"+d.itemdata.uniqueid+"_container .landr_targetWord").addClass("landr_correct"),a("#"+d.itemdata.uniqueid+"_container .landr_feedback").addClass("fa fa-check"),a("#"+d.itemdata.uniqueid+"_container .landr_speech.landr_teacher_left").text(d.items[d.game.pointer].target+""),d.items[d.game.pointer].answered=!0,d.items[d.game.pointer].correct=!0,d.items[d.game.pointer].typed=c,a("#"+d.itemdata.uniqueid+"_container .landr_ctrl-btn").prop("disabled",!0),d.game.pointer<d.items.length-1?setTimeout(function(){d.game.pointer++,d.nextPrompt()},3e3):setTimeout(function(){d.end()},3e3)):(b.forEach(function(b){b.matched?(a("#"+d.itemdata.uniqueid+"_container .landr_targetWord[data-idx='"+b.wordnumber+"']").addClass("landr_correct"),a("#"+d.itemdata.uniqueid+"_container .landr_feedback[data-idx='"+b.wordnumber+"']").addClass("fa fa-check")):(a("#"+d.itemdata.uniqueid+"_container .landr_targetWord[data-idx='"+b.wordnumber+"']").addClass("landr_incorrect"),a("#"+d.itemdata.uniqueid+"_container .landr_feedback[data-idx='"+b.wordnumber+"']").addClass("fa fa-times"))}),a("#"+d.itemdata.uniqueid+"_container .landr_reply_"+d.game.pointer).effect("shake",function(){a("#"+d.itemdata.uniqueid+"_container .landr_ctrl-btn").prop("disabled",!1)})),a("#"+d.itemdata.uniqueid+"_container .landr_targetWord.landr_correct").each(function(){var b=a(this).data("realidx"),c=d.items[d.game.pointer].landr_targetWords[b];a(this).val(c)})},getWords:function(a){var b=this,c=!1;"false"==c&&(a=a.toLowerCase());for(var d=a.split(b.spliton).filter(function(a){return""!==a}),e=[],f=0;f<d.length;f++)d[f].match(b.spliton)||e.push(d[f]);return e},getComparison:function(b,d,e){a(".landr_ctrl-btn").prop("disabled",!0),c.call([{methodname:"mod_poodlltime_compare_passage_to_transcript",args:{passage:b,transcript:d,alternatives:"",language:"en-US"},done:function(a){var b=JSON.parse(a);e(!!b&&b)},fail:function(a){console.log(a)}}])},end:function(){var b=this,c=b.items.filter(function(a){return a.correct}).length,d=b.items.length;a("#"+b.itemdata.uniqueid+"_container .landr_results").html("TOTAL<br/>"+c+"/"+d).show(),a(".poodlltime_nextbutton").prop("disabled",!0),setTimeout(function(){a(".poodlltime_nextbutton").prop("disabled",!1),b.next_question()},2e3)},start:function(){var b=this;a("#"+b.itemdata.uniqueid+"_container .landr_ctrl-btn").prop("disabled",!0),a("#"+b.itemdata.uniqueid+"_container .landr_speakbtncontainer").show(),b.items.forEach(function(a){a.spoken="",a.answered=!1,a.correct=!1}),b.game.pointer=0,a("#"+b.itemdata.uniqueid+"_container .landr_game").show(),a("#"+b.itemdata.uniqueid+"_container .landr_start_btn").hide(),a("#"+b.itemdata.uniqueid+"_container .landr_mainmenu").hide(),a("#"+b.itemdata.uniqueid+"_container .landr_controls").show(),b.nextPrompt()},nextPrompt:function(){var b=!1,c=this,d=c.items[c.game.pointer].target,e="<div class='landr_prompt landr_prompt_"+c.game.pointer+"' style='display:none;'>";e+="<i class='fa fa-graduation-cap landr_speech-icon-left'></i>",e+="<div style='margin-left:90px;' class='landr_speech landr_teacher_left'>",e+=b?d:d.replace(/[^a-zA-Z0-9 ]/g,"").replace(/[a-zA-Z0-9]/g,"â€¢"),e+="</div>",e+="</div>",a("#"+c.itemdata.uniqueid+"_container .landr_game").html(e),a(".landr_ctrl-btn").prop("disabled",!1);var f,g=c.items.map(function(a,b){return f="gray",c.items[b].answered&&c.items[b].correct?f="green":c.items[b].answered&&!c.items[b].correct&&(f="red"),"<i style='color:"+f+"' class='fa fa-circle'></i>"}).join(" ");a("#"+c.itemdata.uniqueid+"_container .landr_title").html(g),a(".landr_prompt_"+c.game.pointer).toggle("slide",{direction:"left"}),c.nextReply()},nextReply:function(){var b=this,c=(b.items[b.game.pointer].target,"<div class='landr_reply landr_reply_"+b.game.pointer+"' style='display:none;'>");c+="<i class='fa fa-user landr_speech-icon-right'></i>";var d="",e=1;b.items[b.game.pointer].landr_targetWords.forEach(function(a,c){a.match(b.spliton)?d+=a:(d+="<ruby><input disabled type='text' maxlength='"+a.length+"' size='"+(a.length+1)+"' class='landr_targetWord' data-realidx='"+c+"' data-idx='"+e+"'><rt><i data-idx='"+e+"' class='landr_feedback'></i></rt></ruby>",e++)}),c+="<div style='margin-right:90px;' class='landr_speech landr_right'>"+d+"</div>",c+="</div>",a("#"+b.itemdata.uniqueid+"_container .landr_game").append(c),a(".landr_reply_"+b.game.pointer).toggle("slide",{direction:"right"}),a("#"+b.itemdata.uniqueid+"_container .landr_ctrl-btn").prop("disabled",!1),b.quizhelper.mobile_user()||setTimeout(function(){a("#"+b.itemdata.uniqueid+"_container .landr_listen_btn").trigger("click")},1e3)}}});