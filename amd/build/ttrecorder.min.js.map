{"version":3,"sources":["../src/ttrecorder.js"],"names":["define","$","log","audioHelper","notification","debug","ttr","waveHeight","audio","stream","blob","dataURI","start","end","isRecording","isRecognizing","transcript","submitting","owner","controls","uniqueid","audio_updated","maxTime","passagehash","region","asrurl","init","opts","callback","prepare_html","register_events","onError","error","onStop","stopped","onStream","got_stream","recordercontainer","recorderbutton","data","update_audio","newprops","val","theprop","that","click","toggleRecording","isComplete","show_recorder_pointer","show_recorder_complete","html","recordBtnContent","show","css","gotRecognition","type","capturedspeech","cleanWord","word","replace","toLowerCase","stop","currentTime","interval","setInterval","newaudio","Date","clearInterval","URL","createObjectURL","length","Math","round","deepSpeech2","response","result","trim","alert","name","bodyFormData","FormData","blobname","floor","random","append","oReq","XMLHttpRequest","open","onUploadProgress","onload","status","JSON","parse","console","send"],"mappings":"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","sourcesContent":["define(['jquery', 'core/log', 'mod_poodlltime/ttaudiohelper', 'core/notification'], function ($, log, audioHelper, notification) {\n    \"use strict\"; // jshint ;_;\n    /*\n    *  The TT recorder\n     */\n\n    log.debug('TT Recorder: initialising');\n\n    var ttr= {\n        waveHeight: 75,\n        audio: {\n            stream: null,\n            blob: null,\n            dataURI: null,\n            start: null,\n            end: null,\n            isRecording: false,\n            isRecognizing: false,\n            transcript: null\n        },\n        submitting: false,\n        owner: '',\n        controls: {},\n        uniqueid: null,\n        audio_updated: null,\n        maxTime: 15000,\n        passagehash: null,\n        region: null,\n        asrurl: null,\n\n        init: function(opts){\n            this.uniqueid=opts['uniqueid'];\n            this.callback=opts['callback'];\n            this.prepare_html();\n            this.register_events();\n            audioHelper.init(this.waveHeight,this.uniqueid,this);\n            audioHelper.onError = this.error;\n            audioHelper.onStop = this.stopped;\n            audioHelper.onStream = this.got_stream;\n        },\n\n        prepare_html: function(){\n            this.controls.recordercontainer =$('#ttrec_container_' + this.uniqueid);\n            this.controls.recorderbutton = $('#' + this.uniqueid + '_recorderdiv');\n            this.passagehash =this.controls.recorderbutton.data('passagehash');\n            this.region=this.controls.recorderbutton.data('region');\n            this.asrurl=this.controls.recorderbutton.data('asrurl');\n            this.maxTime=this.controls.recorderbutton.data('maxtime');\n            this.waveHeight=this.controls.recorderbutton.data('waveheight');\n        },\n\n        update_audio: function(newprops,val){\n            if (typeof newprops === 'string') {\n                log.debug('update_audio:' + newprops + ':' + val);\n                if (this.audio[newprops] != val) {\n                    this.audio[newprops] = val;\n                    this.audio_updated();\n                }\n            }else{\n                for (var theprop in newprops) {\n                    this.audio[theprop] = newprops[theprop];\n                    log.debug('update_audio:' + theprop + ':' + newprops[theprop]);\n                }\n                this.audio_updated();\n            }\n        },\n\n        register_events: function(){\n            var that = this;\n            this.controls.recordercontainer.click(function(){\n                that.toggleRecording();\n            });\n\n            this.audio_updated=function() {\n                //pointer\n                if (that.audio.isRecognizing || that.isComplete()) {\n                    that.show_recorder_pointer('none');\n                } else {\n                    that.show_recorder_pointer('auto');\n                }\n\n                //background WHEN?\n                if (that.isComplete()) {\n                    that.show_recorder_complete(true);\n                } else {\n                    that.show_recorder_complete(false);\n                }\n\n                //div content WHEN?\n                that.controls.recorderbutton.html(that.recordBtnContent());\n            }\n\n        },\n\n        show_recorder_pointer: function(show){\n            if(show) {\n                this.controls.recorderbutton.css('pointer-events', 'none');\n            }else{\n                this.controls.recorderbutton.css('pointer-events', 'auto');\n            }\n\n        },\n        show_recorder_complete: function(show){\n            if(show) {\n                this.controls.recorderbutton.css('background', 'green');\n            }else{\n                this.controls.recorderbutton.css('background', '#e52');\n            }\n        },\n\n        gotRecognition:function(transcript){\n            log.debug('transcript');\n            var message={};\n            message.type='speech';\n            message.capturedspeech = transcript;\n            ttr.callback(message);\n        },\n\n        cleanWord: function(word) {\n            return word.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();\n        },\n\n        recordBtnContent: function() {\n            if(!ttr.audio.isRecognizing){\n                if (!ttr.isComplete()) {\n                    if (ttr.audio.isRecording) {\n                        return '<i class=\"fa fa-stop\">';\n                    } else {\n                        return '<i class=\"fa fa-microphone\">';\n                    }\n                } else {\n                    return '<i class=\"fa fa-check\">';\n                }\n            } else {\n                return '<i class=\"fa fa-spinner fa-spin\">';\n            }\n        },\n        toggleRecording: function() {\n            if (ttr.audio.isRecording) {\n                ttr.update_audio('isRecognizing',true);\n                audioHelper.stop();\n            } else {\n                ttr.start();\n            }\n        },\n        got_stream: function(stream) {\n            var newaudio={stream: stream, isRecording: true};\n            ttr.update_audio(newaudio);\n            ttr.currentTime = 0;\n\n            ttr.interval = setInterval(function() {\n                if (ttr.currentTime < ttr.maxTime) {\n                    ttr.currentTime += 10;\n                } else {\n                    ttr.update_audio('isRecognizing',true);\n                   // vm.isRecognizing = true;\n                    audioHelper.stop();\n                }\n            }, 10);\n\n        },\n        start: function() {\n\n            var newaudio = {\n                stream: null,\n                blob: null,\n                dataURI: null,\n                start: new Date(),\n                end: null,\n                isRecording: false,\n                isRecognizing:false,\n                transcript: null\n            };\n            ttr.update_audio(newaudio);\n            audioHelper.start();\n        },\n        stopped: function(blob) {\n\n            clearInterval(ttr.interval);\n\n            var newaudio = {\n                blob: blob,\n                dataURI: URL.createObjectURL(blob),\n                end: new Date(),\n                isRecording: false,\n                length: Math.round((ttr.audio.end - ttr.audio.start) / 1000),\n            };\n            ttr.update_audio(newaudio);\n\n            var scorer= 'abc';\n            ttr.deepSpeech2(ttr.audio.blob, function(response){\n                log.debug(response);\n                ttr.update_audio('isRecognizing',false);\n                if(response.data.result==\"success\" && response.data.transcript){\n                    ttr.gotRecognition(response.data.transcript.trim());\n                } else {\n                    notification.alert(\"Information\",\"We could not recognize your speech.\", \"OK\");\n                }\n            });\n\n        },\n        error: function(error) {\n            switch (error.name) {\n                case 'PermissionDeniedError':\n                case 'NotAllowedError':\n                    notification.alert(\"Error\",'Please allow access to your microphone!', \"OK\");\n                    break;\n                case 'DevicesNotFoundError':\n                case 'NotFoundError':\n                    notification.alert(\"Error\",'No microphone detected!', \"OK\");\n                    break;\n            }\n        },\n\n        deepSpeech2: function(blob, callback) {\n\n\n            var bodyFormData = new FormData();\n            var blobname = ttr.uniqueid + Math.floor(Math.random() * 100) +  '.wav';\n            bodyFormData.append('audioFile', blob, blobname);\n            bodyFormData.append('scorer', ttr.passagehash);\n\n            var oReq = new XMLHttpRequest();\n            oReq.open(\"POST\", ttr.asrurl, true);\n            oReq.onUploadProgress= function(progressEvent) {};\n            oReq.onload = function(oEvent) {\n                if (oReq.status === 200) {\n                    callback(JSON.parse(oReq.response));\n                } else {\n                    console.error(oReq.error);\n                }\n            };\n            oReq.send(bodyFormData);\n\n        },\n\n        //not really OK here, this is something else\n        isComplete: function() {\n            return false;\n        },\n    };//end of return value\n\n    return ttr;\n});"],"file":"ttrecorder.min.js"}