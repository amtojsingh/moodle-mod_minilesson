define(["jquery","jqueryui","core/log","core/ajax","mod_poodlltime/definitions","mod_poodlltime/pollyhelper","mod_poodlltime/cloudpoodllloader"],function(a,b,c,d,e,f,g){"use strict";return c.debug("Poodll Time Speechcards: initialising"),{init:function(a,b,c){this.init_app(a,b,c)},init_app:function(b,e,f){console.log(e);var h={passmark:75,pointer:1,jsondata:null,props:null,dryRun:!1,language:"en-US",terms:[],results:[],controls:{},init:function(){for(var a=0;a<e.sentences.length;a++)h.terms[a]=e.sentences[a].sentence;c.debug("app terms",h.terms),h.language=e.language,this.init_controls(),this.initComponents(),this.register_events()},init_controls:function(){h.controls={},h.controls.star_rating=a("#"+e.uniqueid+"_container .poodlltime_star_rating"),h.controls.next_button=a("#"+e.uniqueid+"_container .poodlltime-speechcards_nextbutton")},next_question:function(){var a={};a.index=b,a.hasgrade=!0,a.totalitems=h.terms.length,a.correctitems=h.results.filter(function(a){return a.points>0}).length,a.grade=Math.round(a.totalitems/a.correctitems*100),f.do_next(a)},register_events:function(){a("#"+e.uniqueid+"_container .poodlltime_nextbutton").on("click",function(a){h.next_question()}),h.controls.next_button.click(function(){h.check(!1),h.is_end()?setTimeout(function(){h.do_end()},200):setTimeout(function(){h.do_next()},200)})},initComponents:function(){var b=function(b){switch(b.type){case"recording":break;case"speech":c.debug("speech at speechcards");var d=b.capturedspeech,e=h.cleanText(d),f=e,g=h.terms[h.pointer-1],i=h.similarity(f,g);if(c.debug("JS similarity: "+f+":"+g+":"+i),i>=h.passmark||h.wordsDoMatch(e,h.terms[h.pointer-1]))return c.debug("local match::"+f+":"+g),h.showStarRating(100),void h.flagCorrectAndTransition();h.checkByPhonetic(f,g).then(function(b){return b===!1?a.Deferred().reject():(c.debug("PHP similarity: "+f+":"+g+":"+b),h.showStarRating(b),b>=h.passmark&&h.flagCorrectAndTransition(),void 0)})}};g.init("poodlltime-recorder-speechcards-"+e.id,b),h.progress_dots(h.results,h.terms),h.writeCurrentTerm()},writeCurrentTerm:function(){a(".poodlltime_speechcards_target_phrase").toggle("slide",{direction:"left"}),a(".poodlltime_speechcards_target_phrase").text(h.terms[h.pointer-1]),a(".poodlltime_speechcards_target_phrase").toggle("slide",{direction:"right"})},flagCorrectAndTransition:function(){h.check(!0),h.is_end()?setTimeout(function(){h.do_end()},700):setTimeout(function(){h.do_next()},700)},wordsDoMatch:function(a,b){return a=h.cleanText(a),b=h.cleanText(b),a==b},similarity:function(a,b){var c=a,d=b;a.length<b.length&&(c=b,d=a);var e=c.length;return 0==e?1:(e-h.editDistance(c,d))/parseFloat(e)},editDistance:function(a,b){a=a.toLowerCase(),b=b.toLowerCase();for(var c=new Array,d=0;d<=a.length;d++){for(var e=d,f=0;f<=b.length;f++)if(0==d)c[f]=f;else if(f>0){var g=c[f-1];a.charAt(d-1)!=b.charAt(f-1)&&(g=Math.min(Math.min(g,e),c[f])+1),c[f-1]=e,e=g}d>0&&(c[b.length]=e)}return c[b.length]},cleanText:function(a){return a.toLowerCase().replace(/[^\w\s]|_/g,"").replace(/\s+/g," ").trim()},checkByPhonetic:function(a,b){return d.call([{methodname:"mod_poodlltime_check_by_phonetic",args:{spoken:a,correct:b,language:h.language}}])[0]},showStarRating:function(a){var b=[!0,!0,!0];a<1&&(b=[!0,!0,!1]),a<h.passmark&&(b=[!0,!1,!1]),a<.5&&(b=[!1,!1,!1]);var c="";b.forEach(function(a){c+=a===!0?'<i class="fa fa-star"></i>':'<i class="fa fa-star-o"></i>'}),h.controls.star_rating.html(c)},check:function(a){var b=1;b=1==a?1:0;var c={points:b};h.results.push(c)},do_next:function(){h.pointer++,h.progress_dots(h.results,h.terms),h.clearStarRating(),h.is_end()?h.do_end():h.writeCurrentTerm()},clearStarRating:function(){h.controls.star_rating.html("· · ·")},do_end:function(){h.next_question()},is_end:function(){return!(h.pointer<=h.terms.length)},progress_dots:function(b,c){var d="",f="";c.forEach(function(a,c){f="darkgray",void 0!==b[c]&&(f=b[c].points?"green":"red"),d+='<i style="color:'+f+';" class="fa fa-circle"></i>'}),a("#"+e.uniqueid+"_container .poodlltime_progress_dots").html(d)}};h.init()}}});