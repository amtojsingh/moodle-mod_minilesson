define ("mod_poodlltime/speechcards",["jquery","jqueryui","core/log","core/ajax","mod_poodlltime/definitions","mod_poodlltime/pollyhelper","mod_poodlltime/cloudpoodllloader","mod_poodlltime/ttrecorder"],function(a,b,c,d,e,f,g,h){"use strict";c.debug("Poodll Time Speechcards: initialising");return{clone:function clone(){return a.extend(!0,{},this)},init:function init(a,b,c){this.init_app(a,b,c)},init_app:function init_app(b,e,f){console.log(e);var g={passmark:75,pointer:1,jsondata:null,props:null,dryRun:!1,language:"en-US",terms:[],results:[],controls:{},init:function init(){for(var a=0;a<e.sentences.length;a++){g.terms[a]=e.sentences[a].sentence}c.debug("app terms",g.terms);g.language=e.language;this.init_controls();this.initComponents();this.register_events()},init_controls:function init_controls(){g.controls={};g.controls.star_rating=a("#"+e.uniqueid+"_container .poodlltime_star_rating");g.controls.next_button=a("#"+e.uniqueid+"_container .poodlltime-speechcards_nextbutton");g.controls.slider=a("#"+e.uniqueid+"_container .poodlltime_speechcards_target_phrase")},next_question:function next_question(){var a={index:b,hasgrade:!0,totalitems:g.terms.length,correctitems:g.results.filter(function(a){return 0<a.points}).length};a.grade=Math.round(100*(a.totalitems/a.correctitems));f.do_next(a)},register_events:function register_events(){a("#"+e.uniqueid+"_container .poodlltime_nextbutton").on("click",function(){g.next_question()});g.controls.next_button.click(function(){g.check(!1);if(g.is_end()){setTimeout(function(){g.do_end()},200)}else{setTimeout(function(){g.do_next()},200)}})},initComponents:function initComponents(){var b={};b.uniqueid=e.uniqueid;b.callback=function theCallback(b){switch(b.type){case"recording":break;case"speech":c.debug("speech at speechcards");var d=b.capturedspeech,e=g.cleanText(d),f=e,h=g.terms[g.pointer-1],i=g.similarity(f,h);c.debug("JS similarity: "+f+":"+h+":"+i);if(i>=g.passmark||g.wordsDoMatch(e,g.terms[g.pointer-1])){c.debug("local match::"+f+":"+h);g.showStarRating(100);g.flagCorrectAndTransition();return}g.checkByPhonetic(f,h).then(function(b){if(!1===b){return a.Deferred().reject()}else{c.debug("PHP similarity: "+f+":"+h+":"+b);g.showStarRating(b);if(b>=g.passmark){g.flagCorrectAndTransition()}}});}};h.init(b);g.progress_dots(g.results,g.terms);g.initSlider()},initSlider:function initSlider(){g.controls.slider.text(g.terms[g.pointer-1]);g.controls.slider.show()},writeCurrentTerm:function writeCurrentTerm(){g.controls.slider.toggle("slide",{direction:"left"});g.controls.slider.text(g.terms[g.pointer-1]);g.controls.slider.toggle("slide",{direction:"right"})},flagCorrectAndTransition:function flagCorrectAndTransition(){g.check(!0);if(g.is_end()){setTimeout(function(){g.do_end()},700)}else{setTimeout(function(){g.do_next()},700)}},wordsDoMatch:function wordsDoMatch(a,b){a=g.cleanText(a);b=g.cleanText(b);if(a==b){return!0}return!1},similarity:function similarity(a,b){var c=a,d=b;if(a.length<b.length){c=b;d=a}var e=c.length;if(0==e){return 1}return(e-g.editDistance(c,d))/parseFloat(e)},editDistance:function editDistance(a,b){a=a.toLowerCase();b=b.toLowerCase();for(var c=[],d=0,e;d<=a.length;d++){e=d;for(var f=0;f<=b.length;f++){if(0==d)c[f]=f;else{if(0<f){var g=c[f-1];if(a.charAt(d-1)!=b.charAt(f-1))g=Math.min(Math.min(g,e),c[f])+1;c[f-1]=e;e=g}}}if(0<d)c[b.length]=e}return c[b.length]},cleanText:function cleanText(a){return a.toLowerCase().replace(/[^\w\s]|_/g,"").replace(/\s+/g," ").trim()},checkByPhonetic:function checkByPhonetic(a,b){return d.call([{methodname:"mod_poodlltime_check_by_phonetic",args:{spoken:a,correct:b,language:g.language}}])[0]},showStarRating:function showStarRating(a){var b=[!0,!0,!0];if(1>a){b=[!0,!0,!1]}if(a<g.passmark){b=[!0,!1,!1]}if(.5>a){b=[!1,!1,!1]}var c="";b.forEach(function(a){if(!0===a){c+="<i class=\"fa fa-star\"></i>"}else{c+="<i class=\"fa fa-star-o\"></i>"}});g.controls.star_rating.html(c)},check:function check(a){var b=1;if(!0==a){b=1}else{b=0}var c={points:b};g.results.push(c)},do_next:function do_next(){g.pointer++;g.progress_dots(g.results,g.terms);g.clearStarRating();if(!g.is_end()){g.writeCurrentTerm()}else{g.do_end()}},clearStarRating:function clearStarRating(){g.controls.star_rating.html("\xB7 \xB7 \xB7")},do_end:function do_end(){g.next_question()},is_end:function is_end(){if(g.pointer<=g.terms.length){return!1}else{return!0}},progress_dots:function progress_dots(b,c){var d="",f="";c.forEach(function(a,c){f="darkgray";if(b[c]!==void 0){if(b[c].points){f="green"}else{f="red"}}d+="<i style=\"color:"+f+";\" class=\"fa fa-circle\"></i>"});a("#"+e.uniqueid+"_container .poodlltime_progress_dots").html(d)}};g.init()}}});
//# sourceMappingURL=speechcards.min.js.map
