define ("mod_poodlltime/speechcards",["jquery","jqueryui","core/log","core/ajax","mod_poodlltime/definitions","mod_poodlltime/pollyhelper","mod_poodlltime/cloudpoodllloader"],function(a,b,c,d,e,f,g){"use strict";c.debug("Poodll Time Speechcards: initialising");return{init:function init(a,b,c){this.init_app(a,b,c)},init_app:function init_app(b,e,f){console.log(e);var h={passmark:75,pointer:1,jsondata:null,props:null,dryRun:!1,language:"en-US",terms:[],results:[],controls:{},init:function init(){for(var a=0;a<e.sentences.length;a++){h.terms[a]=e.sentences[a].sentence}h.language=e.language;this.init_controls();this.initComponents();this.register_events()},init_controls:function init_controls(){h.controls={};h.controls.star_rating=a("#"+e.uniqueid+"_container .poodlltime_star_rating");h.controls.next_button=a("#"+e.uniqueid+"_container .poodlltime-speechcards_nextbutton")},register_events:function register_events(){a("#"+e.uniqueid+"_container .poodlltime_nextbutton").on("click",function(){f.do_next({index:b,hasgrade:!0,totalitems:4,correctitems:2,grade:50})});h.controls.next_button.click(function(){h.check(!1);if(h.is_end()){setTimeout(function(){h.do_end()},200)}else{setTimeout(function(){h.do_next()},200)}})},initComponents:function initComponents(){g.init("poodlltime-recorder-speechcards-"+e.id,function theCallback(b){console.log(b);switch(b.type){case"recording":break;case"speech":var d=b.capturedspeech,e=h.cleanText(d),f=e,g=h.terms[h.pointer-1],i=h.similarity(f,g);c.debug("JS similarity: "+f+":"+g+":"+i);if(i>=h.passmark||h.wordsDoMatch(e,h.terms[h.pointer-1])){c.debug("local match::"+f+":"+g);h.showStarRating(100);h.flagCorrectAndTransition();return}h.checkByPhonetic(f,g).then(function(b){if(!1===b){return a.Deferred().reject()}else{c.debug("PHP similarity: "+f+":"+g+":"+b);h.showStarRating(b);if(b>=h.passmark){h.flagCorrectAndTransition()}}});}});h.progress_dots(h.results,h.terms);h.writeCurrentTerm()},writeCurrentTerm:function writeCurrentTerm(){a(".poodlltime_speechcards_target_phrase").text(h.terms[h.pointer-1])},flagCorrectAndTransition:function flagCorrectAndTransition(){h.check(!0);if(h.is_end()){setTimeout(function(){h.do_end()},700)}else{setTimeout(function(){h.do_next()},700)}},wordsDoMatch:function wordsDoMatch(a,b){a=h.cleanText(a);b=h.cleanText(b);if(a==b){return!0}return!1},similarity:function similarity(a,b){var c=a,d=b;if(a.length<b.length){c=b;d=a}var e=c.length;if(0==e){return 1}return(e-h.editDistance(c,d))/parseFloat(e)},editDistance:function editDistance(a,b){a=a.toLowerCase();b=b.toLowerCase();for(var c=[],d=0,e;d<=a.length;d++){e=d;for(var f=0;f<=b.length;f++){if(0==d)c[f]=f;else{if(0<f){var g=c[f-1];if(a.charAt(d-1)!=b.charAt(f-1))g=Math.min(Math.min(g,e),c[f])+1;c[f-1]=e;e=g}}}if(0<d)c[b.length]=e}return c[b.length]},cleanText:function cleanText(a){return a.toLowerCase().replace(/[^\w\s]|_/g,"").replace(/\s+/g," ").trim()},checkByPhonetic:function checkByPhonetic(a,b){return d.call([{methodname:"mod_poodlltime_check_by_phonetic",args:{spoken:a,correct:b,language:h.language}}])[0]},showStarRating:function showStarRating(a){var b=[!0,!0,!0];if(1>a){b=[!0,!0,!1]}if(a<h.passmark){b=[!0,!1,!1]}if(.5>a){b=[!1,!1,!1]}console.log(b,a);var c="";b.forEach(function(a){if(!0===a){c+="<i class=\"fa fa-star\"></i>"}else{c+="<i class=\"fa fa-star-o\"></i>"}});console.log(c);h.controls.star_rating.html(c)},check:function check(a){var b=1;if(!0==a){b=1}else{b=0}var c={points:b};h.results.push(c)},do_next:function do_next(){h.pointer++;h.progress_dots(h.results,h.terms);h.clearStarRating();if(!h.is_end()){h.writeCurrentTerm()}else{h.do_end()}},clearStarRating:function clearStarRating(){h.controls.star_rating.html("\xB7 \xB7 \xB7")},do_end:function do_end(){var a={};a.index=b;a.grade=50;f.do_next(a)},is_end:function is_end(){if(h.pointer<h.terms.length){return!1}else{return!0}},progress_dots:function progress_dots(b,c){var d="",f="";c.forEach(function(a,c){f="darkgray";if(b[c]!==void 0){if(b[c].points){f="green"}else{f="red"}}d+="<i style=\"color:"+f+";\" class=\"fa fa-circle\"></i>"});a("#"+e.uniqueid+"_container .poodlltime_progress_dots").html(d)}};h.init()}}});
//# sourceMappingURL=speechcards.min.js.map
