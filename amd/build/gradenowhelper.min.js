define ("mod_poodlltime/gradenowhelper",["jquery","core/log","mod_poodlltime/definitions","mod_poodlltime/popoverhelper"],function(a,b,c,d){"use strict";b.debug("Gradenow helper: initialising");return{controls:{},currentmode:c.modegrading,constants:{REVIEWMODE_NONE:0,REVIEWMODE_MACHINE:1,REVIEWMODE_HUMAN:2,REVIEWMODE_SCORESONLY:3},cd:{audioplayerclass:c.audioplayerclass,wordplayerclass:c.wordplayerclass,wordclass:c.wordclass,spaceclass:c.spaceclass,badwordclass:c.badwordclass,endspaceclass:c.endspaceclass,unreadwordclass:c.unreadwordclass,unreadspaceclass:c.unreadspaceclass,wpmscoreid:c.wpmscoreid,accuracyscoreid:c.accuracyscoreid,sessionscoreid:c.sessionscoreid,errorscoreid:c.errorscoreid,errorrateid:c.errorrateid,scrateid:c.scrateid,formelementwpmscore:c.formelementwpmscore,formelementaccuracy:c.formelementaccuracy,formelementsessionscore:c.formelementsessionscore,formelementendword:c.formelementendword,formelementtime:c.formelementtime,formelementerrors:c.formelementerrors,formelementselfcorrections:c.formelementselfcorrections,formelementnotes:c.formelementnotes,modebutton:c.modebutton,spotcheckmodebutton:c.spotcheckmodebutton,transcriptmodebutton:c.transcriptmodebutton,msvmodebutton:c.msvmodebutton,gradingmodebutton:c.gradingmodebutton,clearbutton:c.clearbutton,spotcheckmode:c.spotcheckmode,msvmode:c.msvmode,transcriptmode:c.transcriptmode,gradingmode:c.gradingmode,aiunmatched:c.aiunmatched,passagecontainer:c.passagecontainer,maybeselfcorrectedwordclass:c.maybeselfcorrectedwordclass,selfcorrectedwordclass:c.selfcorrectedwordclass,notesclass:c.notesclass,structuralclass:c.structuralclass,meaningclass:c.meaningclass,visualclass:c.visualclass,msvcontainerclass:c.msvcontainerclass},options:{enabletts:!1,targetwpm:100,ttslanguage:"en",totalseconds:60,allowearlyexit:!1,timelimit:60,enforcemarker:!0,totalwordcount:0,wpm:0,accuracy:0,sessionscore:0,endwordnumber:0,errorwords:{},activityid:null,attemptid:null,sesskey:null},init:function init(c){var d="#"+c.id,e=a(d).get(0);if(e){var f=JSON.parse(e.value);a(d).remove()}else{b.debug("Gradenow helper js: No config found on page. Giving up.");return}this.register_controls();this.options.activityid=f.activityid;this.options.attemptid=f.attemptid;this.options.sesskey=f.sesskey;this.options.enabletts=f.enabletts;this.options.ttslanguage=f.ttslanguage;this.options.targetwpm=f.targetwpm;this.options.allowearlyexit=f.allowearlyexit;this.options.timelimit=f.timelimit;this.options.reviewmode=f.reviewmode;this.options.readonly=f.readonly;this.options.totalwordcount=a("."+this.cd.wordclass).length;if(0<f.sessiontime){if(""===f.sessionerrors||null===f.sessionerrors){this.options.errorwords={}}else{this.options.errorwords=JSON.parse(f.sessionerrors)}if(""===f.selfcorrections||null===f.selfcorrections){this.options.selfcorrections={}}else{this.options.selfcorrections=JSON.parse(f.selfcorrections)}this.options.totalseconds=f.sessiontime;this.options.endwordnumber=f.sessionendword;this.options.sessionscore=f.sessionscore;this.options.accuracy=f.accuracy;this.options.wpm=f.wpm;this.options.sessionmatches=JSON.parse(f.sessionmatches);this.options.aidata=f.aidata;if(this.options.aidata){this.options.transcriptwords=f.aidata.transcript.split(" ");this.options.transcriptwords=this.options.transcriptwords.filter(function(a){return""!==a})}else{this.options.transcriptwords=[]}this.redrawgradestate()}else{this.options.endwordnumber=this.options.totalwordcount}var g=a("#"+this.cd.spaceclass+"_"+this.options.endwordnumber);g.addClass(this.cd.endspaceclass);this.register_events();var h=this;(function processloadedaudio(){if(h.options.allowearlyexit){if(h.options.aidata&&h.options.aidata.sessiontime){h.options.totalseconds=h.options.aidata.sessiontime}else{h.options.totalseconds=Math.round(a("#"+h.cd.audioplayerclass).prop("duration"))}}else{h.options.totalseconds=h.options.timelimit}h.controls.formelementtime.val(h.options.totalseconds);h.processscores()})();this.init_popoverhelper()},init_popoverhelper:function init_popoverhelper(){var b=this;d.onReject=function(){var e=a(this).attr("data-wordnumber"),f=e in b.options.errorwords;if(f){d.remove();return}for(var g=b.fetchPlayChain(e),h=g.startword;h<=g.endword;h++){if(!(h in b.options.errorwords)){if(h==e){var i=a("#"+b.cd.wordclass+"_"+h),j=a("#"+b.cd.spaceclass+"_"+h);b.storewordstate(c.stateerror,h,i.text(),{});i.addClass(b.cd.badwordclass);if(h!=g.endword){}}}}b.markup_aiunmatchedspaces();b.processscores();d.remove()};d.onAccept=function(){var c=a(this).attr("data-wordnumber"),e=!(c in b.options.errorwords);if(e){d.remove();return}for(var f=b.fetchPlayChain(c),g=f.startword;g<=f.endword;g++){if(g in b.options.errorwords){if(g==c){delete b.options.errorwords[g];var h=a("#"+b.cd.wordclass+"_"+g),i=a("#"+b.cd.spaceclass+"_"+g);h.removeClass(b.cd.badwordclass)}}}b.markup_aiunmatchedspaces();b.processscores();d.remove()};d.onMSVClose=function(){var c=a(this).attr("data-wordnumber"),e=d.fetchMSVResults();b.markupPlayChain(e.state,c,e.msv,b);b.markup_aiunmatchedspaces();b.processscores();d.remove()};d.init()},getMSVBadge:function getMSVBadge(a){var b="";if(!a){return!1}if(a.m&&"1"===a.m){b+="M"}if(a.s&&"1"===a.s){b+="S"}if(a.v&&"1"===a.v){b+="V"}if(""==b){return!1}else{return b}},getMSVClasses:function getMSVClasses(a){var b="",c="";if(!a){c=this.cd.structuralclass+" "+this.cd.meaningclass+" "+this.cd.visualclass+" ";return{addclasses:b,removeclasses:c}}if(a.s&&1==a.s){b+=this.cd.structuralclass+" "}else{c+=this.cd.structuralclass+" "}if(a.m&&1==a.m){b+=this.cd.meaningclass+" "}else{c+=this.cd.meaningclass+" "}if(a.v&&1==a.v){b+=this.cd.visualclass+" "}else{c+=this.cd.visualclass+" "}return{addclasses:b,removeclasses:c}},markupPlayChain:function markupPlayChain(b,d,e,f){var g="",h="",i=f.getMSVClasses(e);g=i.addclasses;h=i.removeclasses;var j=f.getMSVBadge(e);switch(b){case c.stateerror:g+=f.cd.badwordclass+" ";h+=f.cd.selfcorrectedwordclass+" "+f.cd.maybeselfcorrectedwordclass+" ";break;case c.stateselfcorrect:g+=f.cd.selfcorrectedwordclass+" ";h+=f.cd.badwordclass+" "+f.cd.maybeselfcorrectedwordclass+" ";break;case c.statecorrect:h+=f.cd.badwordclass+" "+f.cd.selfcorrectedwordclass+" "+f.cd.maybeselfcorrectedwordclass+" ";}for(var k=f.fetchPlayChain(d),l=k.startword;l<=k.endword;l++){if(d==l){var m=a("#"+f.cd.wordclass+"_"+l),n=a("#"+f.cd.spaceclass+"_"+l);f.storewordstate(b,l,m.text(),e);m.addClass(g);if(l!=k.endword){n.addClass("")}m.removeClass(h);n.removeClass("");if(j){m.attr("data-msvbadge",j)}else{m.removeAttr("data-msvbadge")}}}},register_controls:function register_controls(){this.controls.wordplayer=a("#"+this.cd.wordplayerclass);this.controls.audioplayer=a("#"+this.cd.audioplayerclass);this.controls.eachword=a("."+this.cd.wordclass);this.controls.eachspace=a("."+this.cd.spaceclass);this.controls.endwordmarker=a("#"+this.cd.spaceclass+"_"+this.options.endwordnumber);this.controls.spotcheckword=a("."+this.cd.spotcheckmode);this.controls.wpmscorebox=a("#"+this.cd.wpmscoreid);this.controls.accuracyscorebox=a("#"+this.cd.accuracyscoreid);this.controls.sessionscorebox=a("#"+this.cd.sessionscoreid);this.controls.errorscorebox=a("#"+this.cd.errorscoreid);this.controls.errorratebox=a("#"+this.cd.errorrateid);this.controls.scratebox=a("#"+this.cd.scrateid);this.controls.formelementwpmscore=a("#"+this.cd.formelementwpmscore);this.controls.formelementsessionscore=a("#"+this.cd.formelementsessionscore);this.controls.formelementaccuracy=a("#"+this.cd.formelementaccuracy);this.controls.formelementendword=a("#"+this.cd.formelementendword);this.controls.formelementerrors=a("#"+this.cd.formelementerrors);this.controls.formelementnotes=a("#"+this.cd.formelementnotes);this.controls.formelementselfcorrections=a("#"+this.cd.formelementselfcorrections);this.controls.formelementtime=a("#"+this.cd.formelementtime);this.controls.passagecontainer=a("."+this.cd.passagecontainer);this.controls.notes=a("#"+this.cd.notesclass);this.controls.modebutton=a("#"+this.cd.modebutton);this.controls.gradingmodebutton=a("#"+this.cd.gradingmodebutton);this.controls.spotcheckmodebutton=a("#"+this.cd.spotcheckmodebutton);this.controls.msvmodebutton=a("#"+this.cd.msvmodebutton);this.controls.transcriptmodebutton=a("#"+this.cd.transcriptmodebutton);this.controls.clearbutton=a("#"+this.cd.clearbutton)},register_events:function register_events(){var b=this;this.controls.passagecontainer.on("click","."+this.cd.badwordclass+", ."+this.cd.maybeselfcorrectedwordclass+", ."+this.cd.selfcorrectedwordclass+", ."+this.cd.aiunmatched,function(){if(b.currentmode===c.modespotcheck||b.currentmode===c.modemsv){var d=parseInt(a(this).attr("data-wordnumber"));b.doPlaySpotCheck(d)}});if(!this.options.readonly){this.controls.notes.change(function(){b.controls.formelementnotes.val(a(this).val())});this.controls.eachword.click(function(){var e=a(this).attr("data-wordnumber"),f=a(this).text(),g={};switch(b.currentmode){case c.modespotcheck:if(a(this).hasClass(b.cd.badwordclass)||a(this).hasClass(b.cd.aiunmatched)){d.addQuickGrader(this)}return;case c.modetranscript:var h=b.fetchTranscriptChunk(e);if(h){d.addTranscript(this,h)}return;case c.modemsv:var i={};if(e in b.options.selfcorrections){i.state=c.stateselfcorrect;i.msv=b.options.selfcorrections[e].msv}else if(e in b.options.errorwords){i.state=c.stateerror;i.msv=b.options.errorwords[e].msv}else{i.state=c.statecorrect;i.msv={s:0,m:0,v:0}}if(!i.msv||!Object.keys(i.msv).length){i.msv={s:0,m:0,v:0}}d.addMSVGrader(this,i);return;case c.modegrading:default:if(b.options.enforcemarker&&+e>+b.options.endwordnumber){return}if(e in b.options.errorwords){b.storewordstate(c.statecorrect,e,f,g);a(this).removeClass(b.cd.badwordclass+" "+b.cd.selfcorrectedwordclass)}else{b.storewordstate(c.stateerror,e,f,g);a(this).removeClass(b.cd.selfcorrectedwordclass);a(this).addClass(b.cd.badwordclass)}var j=b.getMSVClasses(g);a(this).removeClass(j.removeclasses);b.processscores();}});this.controls.eachspace.click(function(){if(b.currentmode===c.modespotcheck||b.currentmode===c.modetranscript||b.currentmode===c.modemsv){return}var d=a(this).attr("data-wordnumber"),e=a("#"+b.cd.spaceclass+"_"+d);if(d===b.options.endwordnumber){b.options.endwordnumber=b.options.totalwordcount;e.removeClass(b.cd.endspaceclass);a("#"+b.cd.spaceclass+"_"+b.options.totalwordcount).addClass(b.cd.endspaceclass)}else{a("#"+b.cd.spaceclass+"_"+b.options.endwordnumber).removeClass(b.cd.endspaceclass);b.options.endwordnumber=d;e.addClass(b.cd.endspaceclass)}b.processunread();b.processscores()});this.controls.clearbutton.click(function(){if(b.currentmode===c.modespotcheck||b.currentmode===c.modetranscript||b.currentmode===c.modemsv){return}a("."+b.cd.badwordclass).each(function(){var c=a(this).attr("data-wordnumber");delete b.options.errorwords[c];a(this).removeClass(b.cd.badwordclass)});a("."+b.cd.wordclass).removeClass(b.cd.unreadwordclass);b.options.endwordnumber=b.options.totalwordcount;a("."+b.cd.spaceclass).removeClass(b.cd.endspaceclass);a("#"+b.cd.spaceclass+"_"+b.options.totalwordcount).addClass(b.cd.endspaceclass);b.processscores()});this.controls.gradingmodebutton.click(function(){b.undoCurrentMode();b.doGradingMode();b.updateButtonStates()})}this.controls.spotcheckmodebutton.click(function(){b.undoCurrentMode();b.doSpotCheckMode();b.updateButtonStates()});this.controls.msvmodebutton.click(function(){b.undoCurrentMode();b.doMSVMode();b.updateButtonStates()});this.controls.transcriptmodebutton.click(function(){b.undoCurrentMode();b.doTranscriptMode();b.updateButtonStates()})},undoCurrentMode:function undoCurrentMode(){switch(this.currentmode){case c.modegrading:this.undoGradingMode();break;case c.modespotcheck:this.undoSpotCheckMode();break;case c.modemsv:this.undoMSVMode();break;case c.modetranscript:this.undoTranscriptMode();break;}},updateButtonStates:function updateButtonStates(){var b=a("a#printattempt");switch(this.currentmode){case c.modegrading:this.controls.gradingmodebutton.prop("disabled",!0);this.controls.spotcheckmodebutton.prop("disabled",!1);this.controls.msvmodebutton.prop("disabled",!1);this.controls.transcriptmodebutton.prop("disabled",!1);b.attr("href",b.attr("data-base-url")+"&mode=manual");break;case c.modespotcheck:this.controls.gradingmodebutton.prop("disabled",!1);this.controls.spotcheckmodebutton.prop("disabled",!0);this.controls.msvmodebutton.prop("disabled",!1);this.controls.transcriptmodebutton.prop("disabled",!1);b.attr("href",b.attr("data-base-url")+"&mode=quick");break;case c.modemsv:this.controls.gradingmodebutton.prop("disabled",!1);this.controls.spotcheckmodebutton.prop("disabled",!1);this.controls.msvmodebutton.prop("disabled",!0);this.controls.transcriptmodebutton.prop("disabled",!1);b.attr("href",b.attr("data-base-url")+"&mode=power");break;case c.modetranscript:this.controls.gradingmodebutton.prop("disabled",!1);this.controls.spotcheckmodebutton.prop("disabled",!1);this.controls.msvmodebutton.prop("disabled",!1);this.controls.transcriptmodebutton.prop("disabled",!0);b.attr("href",b.attr("data-base-url")+"&mode=transcript");break;}},doPlaySpotCheck:function doPlaySpotCheck(b){var c=this.fetchPlayChain(b),d=this.controls.audioplayer[0],e=.5,f=d.duration,g=parseFloat(c.audioend);if(!isNaN(f)&&f>g+e){g=g+e}var h=parseFloat(c.audiostart);if(0<h-e){h=h-e}d.currentTime=h;a(this.controls.audioplayer).off("timeupdate");a(this.controls.audioplayer).on("timeupdate",function(){var b=d.currentTime;if(b>=g){a(this).off("timeupdate");d.pause()}});d.play()},fetchPlayChain:function fetchPlayChain(b){for(var c=b,d=-1,e=b;0<e;e--){var f=a("#"+this.cd.wordclass+"_"+e).hasClass(this.cd.badwordclass),g=a("#"+this.cd.wordclass+"_"+e).hasClass(this.cd.aiunmatched);if(f||g){c=e;if(!g){d=this.options.sessionmatches[""+e].audiostart}else{d=-1}}else{break}}if(-1==d){d=0;for(var e=c-1;0<e;e--){if(this.options.sessionmatches[""+e]){d=this.options.sessionmatches[""+e].audioend;break}}}for(var h=b,i=-1,j=this.options.totalwordcount,e=b;e<=j;e++){var f=a("#"+this.cd.wordclass+"_"+e).hasClass(this.cd.badwordclass),g=a("#"+this.cd.wordclass+"_"+e).hasClass(this.cd.aiunmatched);if(f||g){h=e;if(!g){i=this.options.sessionmatches[""+e].audioend}else{i=-1}}else{break}}if(-1==i){i=this.options.totalseconds;for(var e=h+1;e<=j;e++){if(this.options.sessionmatches[""+e]){i=this.options.sessionmatches[""+e].audiostart;break}}}var k={startword:c,endword:parseInt(h),audiostart:d,audioend:parseInt(i)};return k},markup_aiunmatchedwords:function markup_aiunmatchedwords(){var b=this;if(this.options.sessionmatches){var c=0;a.each(this.options.sessionmatches,function(d){var e=d-c-1;if(0<e){for(var f=1,g;f<e+1;f++){g=c+f;a("#"+b.cd.wordclass+"_"+g).addClass(b.cd.aiunmatched)}}c=parseInt(d)});for(var d=c+1,e;d<=this.options.endwordnumber;d++){e=d;a("#"+b.cd.wordclass+"_"+e).addClass(b.cd.aiunmatched)}}},markup_aiunmatchedspaces:function markup_aiunmatchedspaces(){var b=this;a("."+this.cd.wordclass+"."+this.cd.aiunmatched).each(function(){var d=parseInt(a(this).attr("data-wordnumber"));if(b.currentmode===c.modespotcheck&&a("#"+b.cd.wordclass+"_"+(d+1)).hasClass(b.cd.badwordclass)||a("#"+b.cd.wordclass+"_"+(d+1)).hasClass(b.cd.aiunmatched)){a("#"+b.cd.spaceclass+"_"+d).addClass(b.cd.aiunmatched)}})},doSpotCheckMode:function doSpotCheckMode(){this;this.markup_aiunmatchedwords();this.markup_aiunmatchedspaces();this.controls.passagecontainer.addClass(this.cd.spotcheckmode);this.currentmode="spotcheck"},undoSpotCheckMode:function undoSpotCheckMode(){this.controls.passagecontainer.removeClass(this.cd.spotcheckmode);a("."+this.cd.wordclass).removeClass(this.cd.aiunmatched);a("."+this.cd.spaceclass).removeClass(this.cd.aiunmatched);a(this.controls.audioplayer).off("timeupdate");d.remove()},doMSVMode:function doMSVMode(){this;this.markup_aiunmatchedwords();this.markup_aiunmatchedspaces();this.controls.passagecontainer.addClass(this.cd.msvmode);this.currentmode=c.modemsv},undoMSVMode:function undoMSVMode(){this.controls.passagecontainer.removeClass(this.cd.msvmode);a("."+this.cd.wordclass).removeClass(this.cd.aiunmatched);a("."+this.cd.spaceclass).removeClass(this.cd.aiunmatched);a(this.controls.audioplayer).off("timeupdate");d.remove()},doTranscriptMode:function doTranscriptMode(){var b=this;if(this.options.sessionmatches){var d=0;a.each(this.options.sessionmatches,function(c){var e=c-d-1;if(0<e){for(var f=1,g;f<e+1;f++){g=d+f;a("#"+b.cd.wordclass+"_"+g).addClass(b.cd.aiunmatched)}}d=parseInt(c)});for(var e=d+1,f;e<=this.options.endwordnumber;e++){f=e;a("#"+b.cd.wordclass+"_"+f).addClass(b.cd.aiunmatched)}}a("."+this.cd.aiunmatched).each(function(){var c=parseInt(a(this).attr("data-wordnumber"));if(a("#"+b.cd.wordclass+"_"+(c+1)).hasClass(b.cd.aiunmatched)){a("#"+b.cd.spaceclass+"_"+c).addClass(b.cd.aiunmatched)}});this.controls.passagecontainer.addClass(this.cd.transcriptmode);this.currentmode=c.modetranscript},undoTranscriptMode:function undoTranscriptMode(){this.controls.passagecontainer.removeClass(this.cd.transcriptmode);a("."+this.cd.wordclass).removeClass(this.cd.aiunmatched);a("."+this.cd.spaceclass).removeClass(this.cd.aiunmatched);d.remove()},doGradingMode:function doGradingMode(){this.controls.passagecontainer.addClass(this.cd.gradingmode);this.currentmode=c.modegrading},undoGradingMode:function undoGradingMode(){this.controls.passagecontainer.removeClass(this.cd.gradingmode)},fetchTranscriptChunk:function fetchTranscriptChunk(b){var c=this.options.transcriptwords.length;if(0==c){return""}for(var d=-1,e=b,f;0<e;e--){f=a("#"+this.cd.wordclass+"_"+e).hasClass(this.cd.aiunmatched);if(!f){d=this.options.sessionmatches[""+e].tposition+1;break}}for(var g=-1,e=b,f;e<=c;e++){f=a("#"+this.cd.wordclass+"_"+e).hasClass(this.cd.aiunmatched);if(!f){g=this.options.sessionmatches[""+e].tposition-1;break}}if(-1==d){d=1}if(g==c){g=-1}else if(0==g||g<d){return!1}d--;var h=!1;if(0<g){h=this.options.transcriptwords.slice(d,g).join(" ")}else{h=this.options.transcriptwords.slice(d).join(" ")}if(""==h.trim()){return!1}else{return h}},playword:function playword(){var b=this;b.controls.wordplayer.attr("src",M.cfg.wwwroot+"/"+c.componentpath+"/tts.php?txt="+encodeURIComponent(a(this).text())+"&lang="+b.options.ttslanguage+"&n="+b.options.activityid);b.controls.wordplayer[0].pause();b.controls.wordplayer[0].load();b.controls.wordplayer[0].play()},redrawgradestate:function redrawgradestate(){var b=this;this.processunread();if(this.options.reviewmode!==this.constants.REVIEWMODE_SCORESONLY){a.each(b.options.errorwords,function(c){var d=a("#"+b.cd.wordclass+"_"+b.options.errorwords[c].wordnumber);d.addClass(b.cd.badwordclass);var e=b.getMSVClasses(b.options.errorwords[c].msv);d.addClass(e.addclasses);var f=b.getMSVBadge(b.options.errorwords[c].msv);if(f){d.attr("data-msvbadge",f)}});a.each(b.options.selfcorrections,function(c){var d=b.getMSVClasses(b.options.selfcorrections[c].msv),e=b.getMSVBadge(b.options.selfcorrections[c].msv),f=a("#"+b.cd.wordclass+"_"+b.options.selfcorrections[c].wordnumber);f.addClass(b.cd.selfcorrectedwordclass);f.addClass(d.addclasses);if(e){f.attr("data-msvbadge",e)}});this.controls.notes.val(this.controls.formelementnotes.val());switch(this.currentmode){case c.modegrading:break;case c.modespotcheck:this.doSpotCheckMode();break;case c.modetranscript:this.doTranscriptMode();break;case c.modemsv:this.doMSVMode();break;}}},storewordstate:function storewordstate(a,b,d,e){switch(a){case c.stateerror:this.options.errorwords[b]={word:d,wordnumber:b,msv:e};if(b in this.options.selfcorrections){delete this.options.selfcorrections[b]}break;case c.stateselfcorrect:this.options.selfcorrections[b]={word:d,wordnumber:b,msv:e};if(b in this.options.errorwords){delete this.options.errorwords[b]}break;case c.statecorrect:if(b in this.options.errorwords){delete this.options.errorwords[b]}if(b in this.options.selfcorrections){delete this.options.selfcorrections[b]}}},processword:function processword(){var b=this,d=a(this).attr("data-wordnumber"),e=a(this).text();if(b.options.enforcemarker&&+d>+b.options.endwordnumber){return}if(d in b.options.errorwords){delete b.options.errorwords[d];a(this).removeClass(b.cd.badwordclass)}else{b.storewordstate(c.stateerror,d,e,{});a(this).addClass(b.cd.badwordclass)}b.processscores()},processspace:function processspace(){var b=this,c=a(this).attr("data-wordnumber"),d=a("#"+b.cd.spaceclass+"_"+c);if(c==b.options.endwordnumber){b.options.endwordnumber=b.options.totalwordcount;d.removeClass(b.cd.endspaceclass);a("#"+b.cd.spaceclass+"_"+b.options.totalwordcount).addClass(b.cd.endspaceclass)}else{a("#"+b.cd.spaceclass+"_"+b.options.endwordnumber).removeClass(b.cd.endspaceclass);b.options.endwordnumber=c;d.addClass(b.cd.endspaceclass)}b.processunread();b.processscores()},markup_maybeselfcorrects:function markup_maybeselfcorrects(){var b=this;if(this.options.sessionmatches){var c=!1;a.each(this.options.sessionmatches,function(d,e){var f=!1;if(c){if(1<e.tposition-c.tposition){if(1==e.pposition-c.pposition){if(c.hasOwnProperty("altmatch")&&1===c.altmatch){f=!1}else{f=!0}}}}else if(!1===c){if(e.pposition<e.tposition){if(1==e.pposition){f=!0}}}if(f){a("#"+b.cd.wordclass+"_"+e.pposition).addClass(b.cd.maybeselfcorrectedwordclass)}c=e})}},processunread:function processunread(){var b=this;b.controls.eachword.each(function(){var c=a(this).attr("data-wordnumber"),d=a("#"+b.cd.spaceclass+"_"+c);if(+c>+b.options.endwordnumber){a(this).addClass(b.cd.unreadwordclass);d.addClass(b.cd.unreadspaceclass);if(b.options.enforcemarker&&c in b.options.errorwords){delete b.options.errorwords[c];a(this).removeClass(b.cd.badwordclass)}}else{a(this).removeClass(b.cd.unreadwordclass);d.removeClass(b.cd.unreadspaceclass)}})},processscores:function processscores(){var a=this,b=Object.keys(a.options.errorwords).length;a.controls.errorscorebox.text(b);var c=Object.keys(a.options.selfcorrections).length,d=0;if(0<a.options.totalseconds){d=Math.round(60*(a.options.endwordnumber-b)/a.options.totalseconds)}a.options.wpm=d;a.controls.wpmscorebox.text(d);var e=0;if(0<a.options.endwordnumber){e=Math.round(100*((a.options.endwordnumber-b)/a.options.endwordnumber))}a.options.accuracy=e;a.controls.accuracyscorebox.text(e);var f=d;if(f>a.options.targetwpm){f=a.options.targetwpm}var g=Math.round(100*(f/a.options.targetwpm));a.controls.sessionscorebox.text(g);var h="";if(0<b&&0<a.options.endwordnumber){h="1:"+Math.round(a.options.endwordnumber/b)}else if(0<a.options.endwordnumber){h="-:"+a.options.endwordnumber}else{h="-:-"}a.options.errorrate=h;a.controls.errorratebox.text(h);var i="";if(0<b&&0<c){i="1:"+Math.round((b+c)/c)}else if(0<b){i="-:"+b}else{i="-:-"}a.options.scrate=i;a.controls.scratebox.text(i);a.controls.formelementwpmscore.val(d);a.controls.formelementsessionscore.val(g);a.controls.formelementaccuracy.val(e);a.controls.formelementendword.val(a.options.endwordnumber);a.controls.formelementerrors.val(JSON.stringify(a.options.errorwords));a.controls.formelementselfcorrections.val(JSON.stringify(a.options.selfcorrections))}}});
//# sourceMappingURL=gradenowhelper.min.js.map
